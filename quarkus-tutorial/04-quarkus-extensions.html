<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Quarkus Extensions :: Quarkus Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/quarkus-tutorial/quarkus-tutorial/04-quarkus-extensions.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/quarkus-tutorial">Quarkus Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="quarkus-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#requirements">Required Tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-basics-fundas.html">Basics and Fundamentals</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basics-fundas.html#basics-create-quarkus-app">Create Quarkus Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basics-fundas.html#basics-ide-quarkus-project">Open Application in IDE</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basics-fundas.html#basics-build-run-quarkus-app">Build and Run Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basics-fundas.html#basics-update-code">Update Code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basics-fundas.html#basics-call-svc">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basics-fundas.html#basics-testing">Testing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-basics-fundas.html#basics-logging">Configuring Logging</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-basics-fundas.html#basics-call-svc-logging">Invoke Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-basics-fundas.html#basics-configuration">Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-basics-fundas.html#basics-configuration-new-property">Add New Property</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-basics-fundas.html#basics-configuration-get-value">Get Configuration Value</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-basics-fundas.html#basics-call-configuration">Invoke Service</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-quarkus-panache.html">Hibernate with Quarkus</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-quarkus-panache.html#quarkusp-demo-overview">Demo Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-quarkus-panache.html#quarkusp-fruitapp-dev">Build and Deploy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-quarkus-panache.html#quarkus-fruit-app-db">Deploy Mariadb</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-quarkus-panache.html#quarkusp-access-db">Access Database </a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-quarkus-panache.html#quarkuspdb-update-props">Configure Application properties</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-quarkus-panache.html#quarkusp-create-fruit-entity">Create Fruit Entity</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-quarkus-panache.html#quarkusp-edit-fruit-resource">Update Fruit Resource</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-quarkus-panache.html#quarkusp-fruits-finder">Finders</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-quarkus-extensions.html">Quarkus Extensions</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#qext-intro">What are Extensions ?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#qext-list-extensions">List Extensions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#qext-rest-client">Rest Client</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-add-rest-client-extensions">Adding Rest Client extension</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-create-fruity-vice-pojo">Creating FruityVice POJO</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-create-fruity-vice-service">Creating FruityVice Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-create-fruity-vice-service-config">Configuring FruityVice Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-create-fruity-vice-service-resclient">Using the RestClient</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-rest-client-run-quarkus-app-dev-mode">Run Quarkus Application in Development mode</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-call-fruity-rest-client">Invoke Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#qext-fault-tolerance">Fault Tolerance</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-add-fault-tolerance-extensions">Adding Fault Tolerance extension</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-retry-fruity-vice-service">Add Retry to Fruity Vice Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-fault-tolerance-run-quarkus-app-dev-mode">Run Quarkus Application in Development mode</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-call-fruity-fault-tolerance-retry">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-fallback-fruity-vice-service">Add Fallback to Fruity Vice Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-fault-tolerance-fallback-run-quarkus-app-dev-mode">Run Quarkus Application in Development mode</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-call-fruity-fault-tolerance-fallback">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-circuit-breaker-fruity-vice-service">Add Ciruict Breaker to Fruity Vice Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-circuit-breaker-run-quarkus-app-dev-mode">Run Quarkus Application in Development mode</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-call-fruity-fault-tolerance-circuit-breaker">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-turn-on-network">Turn Network On</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#qext-health-checks">Health Checks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-add-extensions">Add Extension</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-health-check-default-run-quarkus-app-dev-mode">Run Quarkus Application in Development mode</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-call-health-ep">Invoke Health Endpoint</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-custom-health-check">Customizing Health Checks</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-health-check-custom-run-quarkus-app-dev-mode">Run Quarkus Application in Development mode</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-call-health-custom">Invoke Health Endpoint</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-health-checks-kubernetes">Add Health Probes to Kubernetes Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#qext-jwt">Securing endpoints with JWT</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-add-jwt-extensions">Add Extension</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-configure-jwt-parameters">Configuring JWT parameters</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-jwt-inject-claim">Injecting Claims</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-jwt-claim-quarkus-app-dev-mode">Run Quarkus Application in Development mode</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-call-jwt-claim">Invoke Endpoint</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-jwt-inject-rbac">Add RBAC</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#qext-call-jwt-rbac">Invoke Endpoint</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-quarkus-reactive.html">Reactive Programming with Quarkus</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-quarkus-reactive.html#quarkusrpb-demo-overview">Beer Demo Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-quarkus-reactive.html#quarkusrpb-buld-beer-reactive">Build Beer Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-quarkus-reactive.html#qext-reactive-beer-run-quarkus-app-dev-mode">Run Quarkus Application with Beer Service</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">quarkus-tutorial</a></li>
    <li><a href="04-quarkus-extensions.html">Quarkus Extensions</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/quarkus-tutorial/edit/master/documentation/modules/ROOT/pages/04-quarkus-extensions.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Quarkus Extensions</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to :</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-check-square-o"></i> What is Quarkus Extensions ?</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> How to add them to your Quarkus project?</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> How to make calls to other services with Rest Client</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> How to add fault tolerant behaviour in your service</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> How to add health checks</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> How to secure your endpoints with JWT</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="qext-intro"><a class="anchor" href="#qext-intro"></a>What are extensions ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Extensions are set of dependencies that can added to the Quarkus project in need of a specific features e.g. health checks.  Extensions configure, boot and integrate a framework or technology into your Quarkus application. They also do all of the heavy lifting of providing the right information to GraalVM for your application to compile natively.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="qext-list-extensions"><a class="anchor" href="#qext-list-extensions"></a>Listing Extensions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Quarkus maven plugin can list all available supported extensions.</p>
</div>
<div class="paragraph">
<p>Navigate to the tutorial&#8217;s <code>work</code> folder or the root folder where you created the project:</p>
</div>
<div id="qext-nav-to-work-folder" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/work</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The instructions of this section assumes your project name to be <code>fruits-app</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To list the available extensions, run the following command from your project directory.</p>
</div>
<div id="qext-mvn-list-extensions" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd fruits-app &amp;&amp; \
./mvnw quarkus:list-extensions</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="qext-rest-client"><a class="anchor" href="#qext-rest-client"></a>Rest Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a microservices architecture, and generally speaking, any kind of application, might need to access other RESTful Web Services.
Quarkus provides a Rest client following the <a href="https://github.com/eclipse/microprofile-rest-client">MicroProfile Rest Client</a> spec.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create a Rest client that access to <a href="http://www.fruityvice.com" class="bare">http://www.fruityvice.com</a> to get nutrition facts about fruits.
Two endpoints are the important ones for this workshop:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>api/fruit/all</code> that returns all fruits.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[{
    "genus": "Malus",
    "name": "Apple",
    "id": 6,
    "family": "Rosaceae",
    "order": "Rosales",
    "nutritions": {
        "carbohydrates": 11.4,
        "protein": 0.3,
        "fat": 0.4,
        "calories": 52,
        "sugar": 10.3
    }
}, {...}
]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>api/fruit/{name}</code> that returns specific info from given fruit name.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "genus": "Musa",
    "name": "Banana",
    "id": 1,
    "family": "Musaceae",
    "order": "Zingiberales",
    "nutritions": {
        "carbohydrates": 22,
        "protein": 1,
        "fat": 0.2,
        "calories": 96,
        "sugar": 17.2
    }
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="qext-add-rest-client-extensions"><a class="anchor" href="#qext-add-rest-client-extensions"></a>Adding Rest Client extension</h3>
<div class="paragraph">
<p>To add Rest Client and JSON-B extensions (<code>quarkus-rest-client, quarkus-resteasy-jsonb</code>) to the Quarkus application, run the following command from <code>fruits-app</code> project directory:</p>
</div>
<div id="qext-mvn-add-rest-client-extension" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:add-extension -Dextension="quarkus-rest-client, quarkus-resteasy-jsonb"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-create-fruity-vice-pojo"><a class="anchor" href="#qext-create-fruity-vice-pojo"></a>Creating FruityVice POJO</h3>
<div class="paragraph">
<p>We need to create a POJO object that is used to unmarshal JSON message from <a href="http://www.fruityvice.com" class="bare">http://www.fruityvice.com</a> to Java object.</p>
</div>
<div class="paragraph">
<p>Add new Java file in <code>$PROJECT_HOME/src/main/java/com/example</code> called <code>FruityVice.java</code> with the following contents:</p>
</div>
<div id="quarkusrc-fruity-vice-pojo" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example;

public class FruityVice {

    public static FruityVice EMPTY_FRUIT = new FruityVice();

    private String name;
    private Nutritions nutritions;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Nutritions getNutritions() {
        return nutritions;
    }

    public void setNutritions(Nutritions nutritions) {
        this.nutritions = nutritions;
    }

    public static class Nutritions {
        private double fat;
        private int calories;

        public double getFat() {
            return fat;
        }

        public void setFat(double fat) {
            this.fat = fat;
        }

        public int getCalories() {
            return calories;
        }

        public void setCalories(int calories) {
            this.calories = calories;
        }

    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-create-fruity-vice-service"><a class="anchor" href="#qext-create-fruity-vice-service"></a>Creating FruityVice Service</h3>
<div class="paragraph">
<p>The next thing is to create a Java interface that acts as a client between code and external service.</p>
</div>
<div class="paragraph">
<p>Add new Java file in <code>$PROJECT_HOME/src/main/java/com/example</code> called <code>FruityViceService.java</code> with the following contents:</p>
</div>
<div id="quarkusrc-fruity-vice-service" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example;

import java.util.List;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;

@Path("/api")
@RegisterRestClient
public interface FruityViceService {

    @GET
    @Path("/fruit/all")
    @Produces(MediaType.APPLICATION_JSON)
    public List&lt;FruityVice&gt; getAllFruits();

    @GET
    @Path("/fruit/{name}")
    @Produces(MediaType.APPLICATION_JSON)
    public FruityVice getFruitByName(@PathParam("name") String name);

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-create-fruity-vice-service-config"><a class="anchor" href="#qext-create-fruity-vice-service-config"></a>Configuring FruityVice Service</h3>
<div class="paragraph">
<p>Add the following properties to <code>$PROJECT_HOME/src/main/resources/application.properties</code>:</p>
</div>
<div id="quarkusrc-config-fruity-update-props" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">com.example.FruityViceService/mp-rest/url=http://www.fruityvice.com</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-create-fruity-vice-service-resclient"><a class="anchor" href="#qext-create-fruity-vice-service-resclient"></a>Using the RestClient</h3>
<div class="paragraph">
<p>Open the following Java class <code>$PROJECT_HOME/src/main/java/com/example/FruitResource.java</code> and copy the next content in its body:</p>
</div>
<div id="quarkusrc-fruity-vice-service-inject" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RestClient
FruityViceService fruityViceService;

@GET
@Path("{name}")
@Produces(MediaType.APPLICATION_JSON)
public FruityVice getFruitInfoByName(@PathParam("name") String name) {
    return fruityViceService.getFruitByName(name);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="qext-rest-client-run-quarkus-app-dev-mode"><a class="anchor" href="#qext-rest-client-run-quarkus-app-dev-mode"></a>Run Quarkus Application in Development mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are not in dev mode, run the following command to start Quarkus application in development mode:</p>
</div>
<div id="rest-client-build-run-dev" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw compile quarkus:dev</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="qext-call-fruity-rest-client"><a class="anchor" href="#qext-call-fruity-rest-client"></a>Invoke Service</h3>
<div class="paragraph">
<p>The simple <code>fruit/banana</code> REST URI can be called via browser using <a href="http://localhost:8080/fruit/banana" class="bare">http://localhost:8080/fruit/banana</a> or using CLI like:</p>
</div>
<div id="rest-client-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/fruit/banana</code></pre>
</div>
</div>
<div class="paragraph">
<p>The REST call should return an response like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "name":"Banana",
    "nutritions":{
        "calories":96,
        "fat":0.2
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="qext-fault-tolerance"><a class="anchor" href="#qext-fault-tolerance"></a>Fault Tolerance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is increasingly important to build fault tolerant micro services. Fault tolerance is about leveraging different strategies to guide the execution and result of some logic. Retry policies, bulkheads, and circuit breakers are popular concepts in this area.
Quarkus integrates with <a href="https://github.com/eclipse/microprofile-fault-tolerance">MicroProfile Fault Tolerance</a> spec to provide resiliency capabilities.</p>
</div>
<div class="sect2">
<h3 id="qext-add-fault-tolerance-extensions"><a class="anchor" href="#qext-add-fault-tolerance-extensions"></a>Adding Fault Tolerance extension</h3>
<div class="paragraph">
<p>To add Fault Tolernace extension (<code>quarkus-smallrye-fault-tolerance</code>) to the Quarkus application, run the following command from <code>fruits-app</code> project directory:</p>
</div>
<div id="qext-mvn-add-fault-tolernace-extension" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:add-extension -Dextension="quarkus-smallrye-fault-tolerance"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-retry-fruity-vice-service"><a class="anchor" href="#qext-retry-fruity-vice-service"></a>Add Retry to Fruity Vice Service</h3>
<div class="paragraph">
<p>Let&#8217;s add the retry policy in <code>FruityViceService</code>.</p>
</div>
<div class="paragraph">
<p>Add the <code>org.eclipse.microprofile.faulttolerance.Retry</code> annotation to <code>$PROJECT_HOME/src/main/java/java/com/example/FruityViceService.java</code>:</p>
</div>
<div id="quarkusft-retry-fruit-vice-service" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">@GET
@Path("/fruit/{name}")
@Produces(MediaType.APPLICATION_JSON)
@Retry(maxRetries = 3, delay = 2000)
public FruityVice getFruitByName(@PathParam("name") String name);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now in case of any error, 3 retries are done automatically, waiting for 2 seconds between retries.</p>
</div>
</div>
<div class="sect2">
<h3 id="qext-fault-tolerance-run-quarkus-app-dev-mode"><a class="anchor" href="#qext-fault-tolerance-run-quarkus-app-dev-mode"></a>Run Quarkus Application in Development mode</h3>
<div class="paragraph">
<p>If you are not in dev mode, run the following command to start Quarkus application in development mode:</p>
</div>
<div id="fault-tolerance-build-run-dev" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw compile quarkus:dev</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-call-fruity-fault-tolerance-retry"><a class="anchor" href="#qext-call-fruity-fault-tolerance-retry"></a>Invoke Service</h3>
<div class="paragraph">
<p>The simple <code>fruit/banana</code> REST URI can be called via browser using <a href="http://localhost:8080/fruit/banana" class="bare">http://localhost:8080/fruit/banana</a> or using CLI like:</p>
</div>
<div id="fault-tolerance-retry-cli-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/fruit/banana</code></pre>
</div>
</div>
<div class="paragraph">
<p>The REST call should return an response like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "name":"Banana",
    "nutritions":{
        "calories":96,
        "fat":0.2
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>No change from calls done previously, but now switch off your network so you do not have access to <a href="http://www.fruityvice.com" class="bare">http://www.fruityvice.com</a>.
And make again a request to <a href="http://localhost:8080/fruit/banana" class="bare">http://localhost:8080/fruit/banana</a>.</p>
</div>
<div id="fault-tolerance-retry-no-network-cli-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/fruit/banana</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now after waiting 6 seconds (3 retries x 2 seconds), the next exception is thrown <code>java.net.UnknownHostException: www.fruityvice.com</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="qext-fallback-fruity-vice-service"><a class="anchor" href="#qext-fallback-fruity-vice-service"></a>Add Fallback to Fruity Vice Service</h3>
<div class="paragraph">
<p>Let&#8217;s add a fallback policy in case of an error in <code>FruityViceService</code>.</p>
</div>
<div class="paragraph">
<p>Add the <code>org.eclipse.microprofile.faulttolerance.Fallback</code> annotation to <code>$PROJECT_HOME/src/main/java/java/com/example/FruityViceService.java</code>:</p>
</div>
<div id="quarkusft-fallback-fruit-vice-service" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">@GET
@Path("/fruit/{name}")
@Produces(MediaType.APPLICATION_JSON)
@Retry(maxRetries = 3, delay = 2000)
@Fallback(value = FruityViceRecovery.class)
public FruityVice getFruitByName(@PathParam("name") String name);

public static class FruityViceRecovery implements FallbackHandler&lt;FruityVice&gt; {

    @Override
    public FruityVice handle(ExecutionContext context) {
        return FruityVice.EMPTY_FRUIT;
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now in case of any error, 3 retries are done automatically, waiting for 2 seconds between retries.
If the error persits, then the fallback method is executed.</p>
</div>
</div>
<div class="sect2">
<h3 id="qext-fault-tolerance-fallback-run-quarkus-app-dev-mode"><a class="anchor" href="#qext-fault-tolerance-fallback-run-quarkus-app-dev-mode"></a>Run Quarkus Application in Development mode</h3>
<div class="paragraph">
<p>If you are not in dev mode, run the following command to start Quarkus application in development mode:</p>
</div>
<div id="fault-tolerance-fallback-build-run-dev" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw compile quarkus:dev</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-call-fruity-fault-tolerance-fallback"><a class="anchor" href="#qext-call-fruity-fault-tolerance-fallback"></a>Invoke Service</h3>
<div class="paragraph">
<p>The simple <code>fruit/banana</code> REST URI can be called via browser using <a href="http://localhost:8080/fruit/banana" class="bare">http://localhost:8080/fruit/banana</a> or using CLI like:</p>
</div>
<div id="fault-tolerance-fallback-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/fruit/banana</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now after waiting for 6 seconds (3 retries x 2 seconds), an empty object is sent instead of an exception.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-circuit-breaker-fruity-vice-service"><a class="anchor" href="#qext-circuit-breaker-fruity-vice-service"></a>Add Circuit Breaker to Fruity Vice Service</h3>
<div class="paragraph">
<p>Let&#8217;s add the circuit breaker policy in <code>FruityViceService</code>.</p>
</div>
<div class="paragraph">
<p>Remove previous annotations of fallback and retry policies and add the following annotation to <code>$PROJECT_HOME/src/main/java/java/com/example/FruityViceService.java</code>:</p>
</div>
<div id="quarkusft-circuit-breaker-fruit-vice-service" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">@GET
@Path("/fruit/{name}")
@Produces(MediaType.APPLICATION_JSON)
@CircuitBreaker(requestVolumeThreshold = 4, failureRatio=0.75, delay = 5000)
public FruityVice getFruitByName(@PathParam("name") String name);

public static class FruityViceRecovery implements FallbackHandler&lt;FruityVice&gt; {

    @Override
    public FruityVice handle(ExecutionContext context) {
        return FruityVice.EMPTY_FRUIT;
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, if 3 (4 x 0.75) failures occur among the rolling window of 4 consecutive invocations then the circuit is opened for 5000 ms and then be back to half open.
If the invocation succeeds then the circuit is back to closed again.</p>
</div>
</div>
<div class="sect2">
<h3 id="qext-circuit-breaker-run-quarkus-app-dev-mode"><a class="anchor" href="#qext-circuit-breaker-run-quarkus-app-dev-mode"></a>Run Quarkus Application in Development mode</h3>
<div class="paragraph">
<p>If you are not in dev mode, run the following command to start Quarkus application in development mode:</p>
</div>
<div id="fault-tolerance-circuit-breaker-build-run-dev" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw compile quarkus:dev</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-call-fruity-fault-tolerance-circuit-breaker"><a class="anchor" href="#qext-call-fruity-fault-tolerance-circuit-breaker"></a>Invoke Service</h3>
<div class="paragraph">
<p>Do 5 consecutive calls to the service, <code>fruit/banana</code> REST URI can be called via browser using <a href="http://localhost:8080/fruit/banana" class="bare">http://localhost:8080/fruit/banana</a> or using CLI like:</p>
</div>
<div id="fault-tolerance-cb-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/fruit/banana</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output changes form <code>java.net.UnknownHostException: www.fruityvice.com</code> (or any other network exception) in the first calls to <code>org.eclipse.microprofile.faulttolerance.exceptions.CircuitBreakerOpenException: getFruitByName</code> when circuit is opened.</p>
</div>
<div class="paragraph">
<p>The big difference between first exception and second one is that in first one, occurs because the circuit is closed and means that the system is trying to reach the host, in the second one, the circuit is closed and the exception is thrown automatically instead of trying to reach the host.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can use <code>@Retry</code> and <code>@Fallback</code> annotations together with <code>@CircuitBreaker</code> annotation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="qext-turn-on-network"><a class="anchor" href="#qext-turn-on-network"></a>Turn Network on</h3>
<div class="paragraph">
<p>Turn network on again to continue with the workshop.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="qext-health-checks"><a class="anchor" href="#qext-health-checks"></a>Health checks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you had observed, the quarkus application deployed on Kubernetes does not have any health checks on it. As Kubernetes best practice its highly recommended that health checks be added to the all the deployments.</p>
</div>
<div class="paragraph">
<p>Health checks in Kubernetes can be added using <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">Liveness and Readiness</a> probes.</p>
</div>
<div class="sect2">
<h3 id="qext-add-extensions"><a class="anchor" href="#qext-add-extensions"></a>Adding Health Check extension</h3>
<div class="paragraph">
<p>We can add <code>quarkus-smallrye-health</code> extension to allow Quarkus application to be probed on the REST endpoint called <code>health</code> to know about its current health.</p>
</div>
<div class="paragraph">
<p>To add <code>quarkus-smallrye-health</code> to the Quarkus application, run the following command from <code>fruits-app</code> project directory:</p>
</div>
<div id="qext-mvn-add-extension" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:add-extension -Dextension="quarkus-smallrye-health"</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful execution of the above command, you will have the following dependency added to the <code>fruits-app</code> project&#8217;s pom.xml:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">...
    &lt;dependency&gt;
      &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
      &lt;artifactId&gt;quarkus-smallrye-health&lt;/artifactId&gt;
    &lt;/dependency&gt;
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-health-check-default-run-quarkus-app-dev-mode"><a class="anchor" href="#qext-health-check-default-run-quarkus-app-dev-mode"></a>Run Quarkus Application in Development mode</h3>
<div class="paragraph">
<p>If you are not in dev mode, run the following command to start Quarkus application in development mode:</p>
</div>
<div id="health-check-default-build-run-dev" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw compile quarkus:dev</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-call-health-ep"><a class="anchor" href="#qext-call-health-ep"></a>Invoke Service</h3>
<div class="paragraph">
<p>The simple <code>health</code> REST URI can be called via browser using <code><a href="http://localhost:8080/health" class="bare">http://localhost:8080/health</a></code> or using CLI like:</p>
</div>
<div id="basics-health-check-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/health</code></pre>
</div>
</div>
<div class="paragraph">
<p>The REST call about should return an response like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "checks": [],
    "outcome": "UP"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can stop the App by typing <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>.</p>
</div>
</div>
<div class="sect2">
<h3 id="qext-custom-health-check"><a class="anchor" href="#qext-custom-health-check"></a>Customizing Health Checks</h3>
<div class="paragraph">
<p>So far, you&#8217;ve seen that some a default health check is provided but in most cases, you&#8217;d like to customize this logic providing custom logic.
Moreover, Kubernetes provides the concept of liveness and readiness probe to regularly check the health of the application.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">liveness</dt>
<dd>
<p>Checks if the application is up and running.</p>
</dd>
<dt class="hdlist1">readiness</dt>
<dd>
<p>Checks if the application can receive public requests.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Let&#8217;s create a custom check for both liveness and readiness checks.
Add new Java file in <code>$PROJECT_HOME/src/main/java/com/example</code> called <code>FruitHealthCheck</code> with the following contents:</p>
</div>
<div id="quarkusp-fruit-checks" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example;

import javax.enterprise.context.ApplicationScoped;
import javax.enterprise.inject.Produces;

import org.eclipse.microprofile.health.HealthCheck;
import org.eclipse.microprofile.health.Liveness;
import org.eclipse.microprofile.health.Readiness;

import io.smallrye.health.HealthStatus;

@ApplicationScoped
public class FruitHealthCheck {

    @Produces
    @ApplicationScoped
    @Liveness
    HealthCheck liveCheck() {
      return HealthStatus.up("successful-live");
    }

    @Produces
    @ApplicationScoped
    @Readiness
    HealthCheck readyCheck() {
      return HealthStatus.state("successful-read", this::isReady);
    }

    private boolean isReady() {
        return true;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-health-check-custom-run-quarkus-app-dev-mode"><a class="anchor" href="#qext-health-check-custom-run-quarkus-app-dev-mode"></a>Run Quarkus Application in Development mode</h3>
<div class="paragraph">
<p>If you are not in dev mode, run the following command to start Quarkus application in development mode:</p>
</div>
<div id="health-check-custom-build-run-dev" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw compile quarkus:dev</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-call-health-custom"><a class="anchor" href="#qext-call-health-custom"></a>Invoke Service</h3>
<div class="paragraph">
<p>The simple <code>health</code> REST URI can be called via browser using <code><a href="http://localhost:8080/health" class="bare">http://localhost:8080/health</a></code> or using CLI like:</p>
</div>
<div id="custom-health-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/health</code></pre>
</div>
</div>
<div class="paragraph">
<p>The REST call about should return an response like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "UP",
    "checks": [
        {
            "name": "successful-live",
            "status": "UP"
        },
        {
            "name": "successful-read",
            "status": "UP"
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>But also you can invoke them individually by calling <code>/health/live</code> and <code>/health/ready</code>.</p>
</div>
<div id="custom-health-live-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/health/live</code></pre>
</div>
</div>
<div class="paragraph">
<p>The REST call about should return an response like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "UP",
    "checks": [
        {
            "name": "successful-live",
            "status": "UP"
        }
    ]
}</code></pre>
</div>
</div>
<div id="custom-health-ready-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/health/ready</code></pre>
</div>
</div>
<div class="paragraph">
<p>The REST call about should return an response like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "UP",
    "checks": [
        {
            "name": "successful-read",
            "status": "UP"
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can stop the container by typing <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>.</p>
</div>
</div>
<div class="sect2">
<h3 id="qext-health-checks-kubernetes"><a class="anchor" href="#qext-health-checks-kubernetes"></a>Kubernetes Extension and Health Checks</h3>
<div class="paragraph">
<p>Kubernetes extension detects that Health Check extension is registered and registers them in generated Kubernetes resource.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have not deployed the application previously, you need to add Quarkus Kubernetes extension. This extension uses <a href="https://github.com/dekorateio/dekorate">Dekorate</a> to generate a default Kubernetes resource template.</p>
</div>
<div id="qext-mvn-add-kubernetes-extension" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:add-extension -Dextensions="quarkus-kubernetes"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to configure group and name of the Docker container used to deploy into Kubernetes.</p>
</div>
<div class="paragraph">
<p>Add the following properties (if you haven&#8217;t already done it before) to $PROJECT_HOME/src/main/resources/application.properties:</p>
</div>
<div id="quarkusk8s-update-props" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">kubernetes.group=example
quarkus.application.name=fruits-app</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now you need to run Maven goal to generate Kubernetes resource.</p>
</div>
<div id="quarkusk8s-generate-kubernetes" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can inspect the generated file by accessing next file:</p>
</div>
<div id="quakrusk8s-generated-kubernetes-resource" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat target/kubernetes/kubernetes.yml</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset1_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_kubectl">
<div id="health-checkk8s-delete-k8s-app" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete all --all</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_oc">
<div id="health-checkk8s-delete-oc-app" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete all --all</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="qext-jwt"><a class="anchor" href="#qext-jwt"></a>Securing endpoints with JWT</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a microservices architecture, and generally speaking, any kind of application, might need to be protected so only certain users can access to the defined endpoint.
Quarkus provides an integration to the <a href="https://github.com/eclipse/microprofile-jwt-auth">MicroProfile JWT RBAC</a> spec.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s see how you can start using JWT for role based access control (RBAC) of endpoints.</p>
</div>
<div class="sect2">
<h3 id="qext-add-jwt-extensions"><a class="anchor" href="#qext-add-jwt-extensions"></a>Adding JWT RBAC extension</h3>
<div class="paragraph">
<p>To add JWT RBAC extension (<code>quarkus-smallrye-jwt</code>) to the Quarkus application, run the following command from <code>fruits-app</code> project directory:</p>
</div>
<div id="qext-mvn-add-jwt-extension" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:add-extension -Dextension="quarkus-smallrye-jwt"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-configure-jwt-parameters"><a class="anchor" href="#qext-configure-jwt-parameters"></a>Configuring JWT parameters</h3>
<div class="paragraph">
<p>Add the following properties to <code>$PROJECT_HOME/src/main/resources/application.properties</code>:</p>
</div>
<div id="quarkussec-config-jwt" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">mp.jwt.verify.publickey.location=https://gist.githubusercontent.com/lordofthejars/9a0b47298c807739a9eb1adfba50795e/raw/0c6d1ed65d38e4dd48992f7410a29aa4e5a35131/quarkus.jwt.pub.jwk.json
<i class="conum" data-value="1"></i><b>(1)</b>
mp.jwt.verify.issuer=https://quarkus.io/using-jwt-rbac
<i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sets the location of public key to verify the token</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Issuer of the token</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We are also providing a valid token that can be verified by the configured public key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  "kid": "/privateKey.pem",
  "typ": "JWT",
  "alg": "RS256"
},
{
  "sub": "jdoe-using-jwt-rbac",
  "aud": "using-jwt-rbac",
  "upn": "jdoe@quarkus.io",
  "birthdate": "2001-07-13",
  "auth_time": 1570094171,
  "iss": "https://quarkus.io/using-jwt-rbac", <i class="conum" data-value="1"></i><b>(1)</b>
  "roleMappings": {
    "group2": "Group2MappedRole",
    "group1": "Group1MappedRole"
  },
  "groups": [ <i class="conum" data-value="2"></i><b>(2)</b>
    "Echoer",
    "Tester",
    "Subscriber",
    "group2"
  ],
  "preferred_username": "jdoe",
  "exp": 2200814171,
  "iat": 1570094171,
  "jti": "a-123"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The issuer you set in <code>application.properties</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>groups</code> field is used by <code>MicroProfile JWT RBAC</code> to get the access groups (or roles) that the owner of the token has</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="qext-jwt-inject-claim"><a class="anchor" href="#qext-jwt-inject-claim"></a>Inject claims into an Object</h3>
<div class="paragraph">
<p>You can inject any defined claim into an object by using <code>@Claim</code> annotation:</p>
</div>
<div class="paragraph">
<p>Open <code>$PROJECT_HOME/src/main/java/java/com/example/FruitResource.java</code> and inject username claim:</p>
</div>
<div id="quarkussec-jwt-claim-username" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">@Inject @Claim(standard = Claims.preferred_username)
String username;

@GET
@Path("/claim")
public String getClaim() {
    return username;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rename the <code>@Path</code> used in <code>FruityVice getFruitInfoByName</code> to <code>@Path("name-{name})"</code> to avoid conflict with the path <code>/fruit/claim</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="qext-jwt-claim-quarkus-app-dev-mode"><a class="anchor" href="#qext-jwt-claim-quarkus-app-dev-mode"></a>Run Quarkus Application in Development mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are not in dev mode, run the following command to start Quarkus application in development mode:</p>
</div>
<div id="jwt-claim-dev-build-run-dev" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw compile quarkus:dev</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="qext-call-jwt-claim"><a class="anchor" href="#qext-call-jwt-claim"></a>Invoke Service</h3>
<div class="paragraph">
<p>The simple <code>fruit/claim</code> REST URI can be called via browser using <a href="http://localhost:8080/fruit/claim" class="bare">http://localhost:8080/fruit/claim</a> or using CLI like:</p>
</div>
<div id="jwt-claim-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">token=$(curl https://gist.githubusercontent.com/lordofthejars/9a0b47298c807739a9eb1adfba50795e/raw/5f8c5b7a9c11ed455f4910ed2032d79612b5e6f6/quarkus.jwt.token -s)
curl -H "Authorization: Bearer $token" localhost:8080/fruit/claim</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you&#8217;ll see the <code>preferred_username</code> field for the given token (<code>jdoe</code>).</p>
</div>
<div class="paragraph">
<p>MircoProfile JWT RBAC spec is providing out-of-the-box the validation of the given token.
These validations include for example that the token has not been modified, has not expired or the issuer is the expected one.</p>
</div>
<div class="paragraph">
<p>To validate this just invoke again the service but changing the token:</p>
</div>
<div id="jwt-claim-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">token=XXXX
curl -H "Authorization: Bearer $token" localhost:8080/fruit/claim</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now the invocation returns and HTTP code <code>401 Unauthorized</code> because the token is invalid.</p>
</div>
</div>
<div class="sect2">
<h3 id="qext-jwt-inject-rbac"><a class="anchor" href="#qext-jwt-inject-rbac"></a>Adds RBAC to the endpoint</h3>
<div class="paragraph">
<p>So far, you&#8217;ve seen how to get claims from the provided JWT token, but anyone could access that endpoint, let&#8217;s protected it with a role.
For this case you need to use a role that is defined in JWT token into <code>groups</code> claim (ie <code>Subscriber</code>).</p>
</div>
<div class="paragraph">
<p>Open <code>$PROJECT_HOME/src/main/java/java/com/example/FruitResource.java</code> and annotate the method with <code>javax.annotation.security.RolesAllowed</code>:</p>
</div>
<div id="quarkussec-jwt-rbac" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">@GET
@Path("/claim")
@RolesAllowed("Subscriber")
public String getClaim() {
    return username;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-call-jwt-rbac"><a class="anchor" href="#qext-call-jwt-rbac"></a>Invoke Service</h3>
<div class="paragraph">
<p>The simple <code>fruit/claim</code> REST URI can be called via browser using <a href="http://localhost:8080/fruit/claim" class="bare">http://localhost:8080/fruit/claim</a> or using CLI like:</p>
</div>
<div id="rjwt-rbac-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">token=$(curl https://gist.githubusercontent.com/lordofthejars/9a0b47298c807739a9eb1adfba50795e/raw/5f8c5b7a9c11ed455f4910ed2032d79612b5e6f6/quarkus.jwt.token -s)
curl -H "Authorization: Bearer $token" localhost:8080/fruit/claim</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you&#8217;ll see the <code>preferred_username</code> field for given token (<code>jdoe</code>).</p>
</div>
<div class="paragraph">
<p>But the big difference now, and it is that you see the result only because the token contains in <code>groups</code> claim the <code>Subscriber</code> role.</p>
</div>
<div class="paragraph">
<p>Open <code>$PROJECT_HOME/src/main/java/java/com/example/FruitResource.java</code> and change the  <code>RolesAllowed</code> value to <code>Subscriber2</code>:</p>
</div>
<div id="quarkussec-jwt-rbac-invalid" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">@GET
@Path("/claim")
@RolesAllowed("Subscriber2")
public String getClaim() {
    return username;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then do the request again:</p>
</div>
<div class="paragraph">
<p>The simple <code>fruit/claim</code> REST URI can be called via browser using <a href="http://localhost:8080/fruit/claim" class="bare">http://localhost:8080/fruit/claim</a> or using CLI like:</p>
</div>
<div id="rjwt-rbac-k8s-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">token=$(curl https://gist.githubusercontent.com/lordofthejars/9a0b47298c807739a9eb1adfba50795e/raw/5f8c5b7a9c11ed455f4910ed2032d79612b5e6f6/quarkus.jwt.token -s)
curl -H "Authorization: Bearer $token" localhost:8080/fruit/claim</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the output now is different: <code>Forbidden</code>.</p>
</div>
<div class="paragraph">
<p>This is the result because the provided token does not contain <code>Subscriber2</code> in the <code>groups</code> claim.</p>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
