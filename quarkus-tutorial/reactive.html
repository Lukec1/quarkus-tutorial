<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Reactive Programming :: Quarkus Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/quarkus-tutorial/quarkus-tutorial/reactive.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/quarkus-tutorial">Quarkus Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="quarkus-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html">Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basics</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basics.html">Basics and Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="panache.html">Hibernate with Panache</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="spring.html">Spring Compatibility</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kubernetes.html">Deploy to Kubernetes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cloud Native</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="reactive.html">Reactive with Mutiny</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kafka-and-streams.html">Apache Kafka with Reactive Streams</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="rest-client.html">REST Client</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="fault-tolerance.html">Fault Tolerance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="health.html">Health Check</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="metrics.html">Metrics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Advanced</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security.html">Security with JWT RBAC</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">quarkus-tutorial</a></li>
    <li>Cloud Native</li>
    <li><a href="reactive.html">Reactive with Mutiny</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/quarkus-tutorial/edit/master/documentation/modules/ROOT/pages/reactive.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Reactive Programming</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/reactive.adoc - include::_attributes.adoc[]
:quarkus-project-name: fruits-app
:svc-path: beer</p>
</div>
<div class="paragraph">
<p>At the end of this chapter you will be able to :</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-check-square-o"></i> Use reactive programming in Quarkus.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> How to use Reactive programming for accessing Rest API services with pagination and back pressure.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quarkusrpb-demo-overview"><a class="anchor" href="#quarkusrpb-demo-overview"></a>Beer Demo Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To demonstrate how to use reactive programming in Quarkus, you will be developing a REST client that connects to a beer database (<a href="https://punkapi.com/documentation/v2" class="bare">https://punkapi.com/documentation/v2</a>) to retrieve beer information.
This API does not return all beers at once, but you need to use pagination to navigate through all beer database.</p>
</div>
<div class="paragraph">
<p>In this section, you are going to develop a service that returns all beers with an <em>abv</em> value greater than <em>7.0</em> and using a reactive approach as a solution.</p>
</div>
<div class="sect2">
<h3 id="quarkusrpb-buld-beer-reactive"><a class="anchor" href="#quarkusrpb-buld-beer-reactive"></a>Build Beer Service</h3>
<div class="paragraph">
<p>The skeleton project to get started is the same you created at <a href="#02-basics-fundas.adoc" class="page unresolved">Basics and Fundamentals</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the easier reference, we shall call the <code>fruits-app</code> project folder as $PROJECT_HOME
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="quarkusrpb-add-reactive"><a class="anchor" href="#quarkusrpb-add-reactive"></a>Add Extensions</h4>
<div id="qext-mvn-add-reactive-extensions" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:add-extension -Dextension="quarkus-resteasy-jsonb, quarkus-rest-client, quarkus-smallrye-reactive-streams-operators"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="quarkusrpb-create-pojo"><a class="anchor" href="#quarkusrpb-create-pojo"></a>Create Beer POJO</h4>
<div class="paragraph">
<p>Let&#8217;s create the <code>Beer</code> pojo.</p>
</div>
<div class="paragraph">
<p>Add new Java file in <code>$PROJECT_HOME/src/main/java/com/example</code> called <code>Beer</code> with the following contents:</p>
</div>
<div id="qext-quarkusrpb-beer-pojo" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example;

public class Beer {

    private String name;
    private String tagline;
    private double abv;
    private String description;

    // generate getters/setters</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="quarkusrpb-create-beer-client"><a class="anchor" href="#quarkusrpb-create-beer-client"></a>Create Rest Client to Punk Beer API</h4>
<div class="paragraph">
<p>Add new Java file in <code>$PROJECT_HOME/src/main/java/com/example</code> called <code>BeerGateway</code> with the following contents:</p>
</div>
<div id="qext-quarkusrpb-beer-client" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example;

import java.util.List;
import java.util.concurrent.CompletionStage;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;

import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;

@Path("/v2")
@RegisterRestClient
public interface BeerGateway {

    @GET
    @Path("/beers")
    @Produces(MediaType.APPLICATION_JSON)
    @ClientHeaderParam(name="user-agent", value="curl/7.54.0")
    List&lt;Beer&gt; getBeers(@QueryParam("page") int page); //1

}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Retrieves all beers from a specific page.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="quarkusrpb-configure-props"><a class="anchor" href="#quarkusrpb-configure-props"></a>Edit the application.properties</h5>
<div class="paragraph">
<p>Add the following properties to $PROJECT_HOME/src/main/resources/application.properties:</p>
</div>
<div id="qext-quarkusrpb-update-props" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">com.example.BeerGateway/mp-rest/url=https://api.punkapi.com</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="quarkusrpb-beer-reactive-service"><a class="anchor" href="#quarkusrpb-beer-reactive-service"></a>Create Beer Punk API Reactive Service</h4>
<div class="paragraph">
<p>Let&#8217;s create the service that uses <code>BeerGateway</code> to retrieve beer information by page and reactively emits each of the beer information.</p>
</div>
<div class="paragraph">
<p>Add new Java file in <code>$PROJECT_HOME/src/main/java/com/example</code> called <code>BeerService</code> with the following contents:</p>
</div>
<div id="qext-quarkusrpb-beer-service" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code>package com.example;

import java.util.List;

import javax.enterprise.context.ApplicationScoped;

import org.eclipse.microprofile.rest.client.inject.RestClient;

import io.reactivex.Flowable;
import io.reactivex.schedulers.Schedulers;

@ApplicationScoped
public class BeerService {

    @RestClient
    BeerGateway beerGateway;

    public Flowable&lt;Beer&gt; beers() {
        Flowable&lt;List&lt;Beer&gt;&gt; beerStream = Flowable.generate) -&gt; 1, (page, emitter) -&gt; { //1             final List&lt;Beer&gt; beers = beerGateway.getBeers(page);             if (beers.isEmpty( {
                emitter.onComplete(); //2
            } else {
                emitter.onNext(beers); //3
            }

            return page + 1; //4
        });

        return beerStream
                .subscribeOn(Schedulers.io())
                .flatMap(Flowable::fromIterable); //5
    }

}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Gets first batch of beers</p>
</li>
<li>
<p>Sends an event that the process is completed</p>
</li>
<li>
<p>Emits each beer</p>
</li>
<li>
<p>Gets beers from next page</p>
</li>
<li>
<p>Flatten the list of beers event into event of beers</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So far nothing really new, but notice that now instead of reading all the beers, put them in memory and then filter out by any parameter, you are just emitting them individually per page.
The caller is responsible to manipulate this information as it starts receiving the information and it is not necessary to store all beers in memory but just the ones that matches any condition.</p>
</div>
<div class="paragraph">
<p>Notice that until a caller subscribes to a stream (<code>Flowable</code> in this case), the logic is not executed.</p>
</div>
</div>
<div class="sect3">
<h4 id="quarkusrpb-beer-resource"><a class="anchor" href="#quarkusrpb-beer-resource"></a>Create Beer Resource</h4>
<div class="paragraph">
<p>The last step is to manipulate the beer <em>stream</em> created in the previous section to filter out by <em>abv</em> and return the result to the caller.</p>
</div>
<div class="paragraph">
<p>Add new Java file in <code>$PROJECT_HOME/src/main/java/com/example</code> called <code>BeerResource</code> with the following contents:</p>
</div>
<div id="qext-quarkusrpb-beer-resource" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example;

import javax.inject.Inject;
import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

import org.reactivestreams.Publisher;

@Path("/beer")
@Consumes(MediaType.APPLICATION_JSON)
@Produces(MediaType.APPLICATION_JSON)
public class BeerResource {

    @Inject
    BeerService beerService; //1

    @GET
    public Publisher&lt;Beer&gt; hello() {
        return beerService.beers() //2
                .filter(b -&gt; b.getAbv() &gt; 7.0); //3
                //4
    }
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Injects <code>BeerService</code></p>
</li>
<li>
<p>Gets the beer stream</p>
</li>
<li>
<p>For each beer emitted checks that <em>abv</em> is greater than 7</p>
</li>
<li>
<p>Automatically subscribes to the stream and get back the result as <code>List&lt;Beer&gt;</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The big change here is that now instead of having to deal with all beers in memory and then apply some operations, you are just loading into memory a <em>page</em> of beers, then filter them and finally return them to the caller.</p>
</div>
<div class="paragraph">
<p>Another big advantage is that now the <em>beer servcie</em> is just called if the consumer requests it.
If the operation is canceled/aborted before completion, then you also save IO by not executing the operations.</p>
</div>
<div class="paragraph">
<p>Notice that one of the big advantages of this approach (apart from the memory usage) is that you can apply any reactive operator without modifying the creation of the stream.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qext-reactive-beer-run-quarkus-app-dev-mode"><a class="anchor" href="#qext-reactive-beer-run-quarkus-app-dev-mode"></a>Run Quarkus Application in Development mode</h3>
<div class="paragraph">
<p>If you are not in dev mode, run the following command to start Quarkus application in development mode:</p>
</div>
<div id="beer-reactive-build-run-dev" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw compile quarkus:dev</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="qext-call-beer-reactive-service"><a class="anchor" href="#qext-call-beer-reactive-service"></a>Invoke Service</h4>
<div class="paragraph">
<p>The simple <code>beer</code> REST URI can be called via browser using <a href="http://localhost:8080/beer" class="bare">http://localhost:8080/beer</a> or using CLI like:</p>
</div>
<div id="beer-reactive-k8s-svc-call" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/beer</code></pre>
</div>
</div>
<div class="paragraph">
<p>The REST call about should return an response like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
   {
      "abv":7.2,
      "description":"An Imperial Pilsner in collaboration with beer writers...." ,
      "name":"Avery Brown Dredge",
      "tagline":"Bloggers' Imperial Pilsner."
   },
   ...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
